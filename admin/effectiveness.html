<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Program Effectiveness ‚Äî Admin</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="adminstyle.css">
    <script src="/logo-fallback.js" defer></script>
    <script src="/user-menu.js" defer></script>
</head>

<body>
    <header class="admin-header">
        <div class="header-left">
            <div class="logo-circle small"><img src="../logo/blue-orange-circle-logo.jpg" class="nav-logo" alt="logo" onerror="this.onerror=null;this.src='../logo/Blue%20%26%20Orange%20Circle%20Illustrative%20Education%20Logo.jpg'"></div>
        </div>
        <div class="header-center">NEXT STEP</div>
        <div class="header-right"><button class="user-icon">üë§</button></div>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav>
                <ul>
                    <li class="active"><span class="home-ico">üè†</span> Dashboard</li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a href="#">About</a><a href="#">Contact Us</a></div>
        </aside>

        <main class="admin-main">
            <a class="back-link" href="../index.html">‚Üê</a>
            <h1>Program Effectiveness</h1>

            <div class="page-card effectiveness-card">
                <p class="lead">Did your program prepare you well for your current role?</p>

                <div class="chart-wrap vertical-chart">
                    <div class="y-axis" aria-hidden="true">
                        <span>1000</span>
                        <span>800</span>
                        <span>600</span>
                        <span>400</span>
                        <span>200</span>
                        <span>0</span>
                    </div>
                    <div class="bars" aria-hidden="true">
                        <!-- bars inserted by script -->
                    </div>
                </div>

                <div class="legend-grid effectiveness-legend" aria-hidden="true">
                    <!-- legend rows inserted by script -->
                </div>

            </div>
            <div class="data-note" style="display:none;margin-top:12px;color:#333;font-weight:600;"></div>
        </main>
    </div>

    <footer class="admin-footer">
        <div class="admin-footer-inner">¬© Next Step</div>
    </footer>

    <script>
        (function() {
            // Try a set of likely relative paths (helps when pages are served from different roots)
            const tryPaths = ['./data/effectiveness.json', 'data/effectiveness.json', '../admin/data/effectiveness.json', '/admin/data/effectiveness.json'];

            // Embedded fallback demo data ‚Äî used when fetch fails (for file:// or CORS cases)
            const fallback = {
                summary: {
                    max: 1000,
                    bins: [{
                        label: 'Extremely Well',
                        count: 700,
                        color: '#1f9f17'
                    }, {
                        label: 'Well',
                        count: 400,
                        color: '#74c043'
                    }, {
                        label: 'Moderate',
                        count: 250,
                        color: '#f2da4a'
                    }, {
                        label: 'Slightly',
                        count: 100,
                        color: '#ffb84d'
                    }, {
                        label: 'Not at all',
                        count: 35,
                        color: '#ff4b4b'
                    }]
                }
            };

            const leadEl = document.querySelector('.effectiveness-card .lead');

            async function fetchFirst(paths) {
                for (const p of paths) {
                    try {
                        const res = await fetch(p);
                        if (!res.ok) throw new Error(`HTTP ${res.status} when fetching ${p}`);
                        const json = await res.json();
                        return {
                            json,
                            path: p
                        };
                    } catch (e) {
                        console.warn('effectiveness fetch failed for', p, e && e.message ? e.message : e);
                        // continue to next path
                    }
                }
                return null;
            }

            function render(data, note) {
                if (!data || !data.summary || !Array.isArray(data.summary.bins)) {
                    // show a subtle note below the card instead of replacing the lead text
                    const noteEl = document.querySelector('.data-note');
                    if (noteEl && note) {
                        noteEl.style.display = 'block';
                        noteEl.textContent = note;
                    }
                    return;
                }
                const noteEl = document.querySelector('.data-note');
                if (noteEl) {
                    noteEl.style.display = note ? 'block' : 'none';
                    noteEl.textContent = note || '';
                }
                const bins = data.summary.bins;
                const max = data.summary.max || Math.max(...bins.map(b => b.count), 1000);
                const barsEl = document.querySelector('.bars');
                barsEl.innerHTML = '';
                bins.forEach((bin, idx) => {
                    const pct = Math.round((bin.count / max) * 100);
                    const bar = document.createElement('div');
                    bar.className = 'v-bar';
                    // use CSS variable --h for animation target and --d for stagger delay
                    bar.innerHTML = `<div class="v-fill" style="--h:${pct}%;--d:${idx * 140}ms;background:${bin.color || '#6b8e23'}" role="img" aria-label="${bin.label}: ${bin.count}"></div><div class="v-label">${bin.label}</div>`;
                    barsEl.appendChild(bar);
                });
                // legend
                const legend = document.querySelector('.effectiveness-legend');
                legend.innerHTML = '';
                bins.forEach(bin => {
                    const r = document.createElement('div');
                    r.className = 'legend-item';
                    r.innerHTML = `<span class="legend-swatch" style="background:${bin.color||'#6b8e23'}"></span><span>${bin.label}</span>`;
                    legend.appendChild(r);
                });
            }

            // Attempt to fetch the real data; fallback to embedded demo data if that fails.
            (async function() {
                try {
                    const result = await fetchFirst(tryPaths);
                    if (result && result.json) {
                        render(result.json);
                        console.log('Loaded effectiveness data from', result.path);
                        return;
                    }
                    // no fetch succeeded ‚Äî use fallback and show a helpful note
                    console.warn('All fetch attempts failed; using embedded fallback dataset. If you opened this file with file://, start a local static server instead.');
                    render(fallback, 'Using demo data (could not load local JSON). Start a static server to load live data.');
                } catch (e) {
                    console.error('Unexpected error in effectiveness loader', e);
                    render(fallback, 'Using demo data due to error. See console for details.');
                }
            })();

        })();
    </script>
</body>

</html>
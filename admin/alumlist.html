<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Alumni List - Admin</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="adminstyle.css">
    <script src="/logo-fallback.js" defer></script>
    <script src="/user-menu.js" defer></script>
    <script src="/supabase-client.js" defer></script>
</head>

<body>
    <header class="admin-header">
        <div class="header-left">
            <div class="logo-circle small"><img src="../logo/blue-orange-circle-logo.jpg" class="nav-logo" alt="logo" onerror="this.onerror=null;this.src='../logo/Blue%20%26%20Orange%20Circle%20Illustrative%20Education%20Logo.jpg'"></div>
        </div>
        <div class="header-center">NEXT STEP</div>
        <div class="header-right"><button class="user-icon">üë§</button></div>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav>
                <ul>
                    <li><a href="index.html"><span class="home-ico">üè†</span> Dashboard</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><a href="#">About</a><a href="#">Contact Us</a></div>
        </aside>

        <main class="admin-main">
            <a class="back-link" href="index.html">‚Üê</a>
            <div class="page-card">
                <h2>Alumni List</h2>
                <div class="table-wrap">
                    <table id="alumTable">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Student Number</th>
                                <th>Degree</th>
                                <th>Graduation Year</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="empty">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Map of degree codes to full labels (match the options used in alumni/Information.html)
        const degreeLabels = {
            'BSA': 'Bachelor of Science in Accountancy (BSA)',
            'BSCpE': 'Bachelor of Science in Computer Engineering (BSCpE)',
            'BSENTREP': 'Bachelor of Science in Entrepreneurship (BSENTREP)',
            'BSHM': 'Bachelor of Science in Hospitality Management (BSHM)',
            'BSIT': 'Bachelor of Science in Information Technology (BSIT)',
            'BSEDEN': 'Bachelor of Secondary Education major in English (BSEDEN)',
            'BSEDMT': 'Bachelor of Secondary Education major in Mathematics (BSEDMT)',
            'DOMTLOM': 'Diploma in Office Management Technology- Legal Office Management (DOMTLOM)'
        };

        function labelForDegree(codeOrLabel) {
            if (!codeOrLabel) return '';
            // If the stored value is a code that exists in the map, return the mapped label.
            if (degreeLabels[codeOrLabel]) return degreeLabels[codeOrLabel];
            // Otherwise assume it's already a human-friendly label and return as-is.
            return codeOrLabel;
        }
        // fetch alumni list (prefer Supabase if configured, fallback to data/alumni.json)
        async function ensureSupabaseReady(timeout = 2000) {
            const start = Date.now();
            while (Date.now() - start < timeout) {
                if (window.supabase && window.supabase.from) return true;
                if (window.supabaseClientReady === false) return false;
                await new Promise(r => setTimeout(r, 100));
            }
            return !!(window.supabase && window.supabase.from);
        }

        async function loadAlumni() {
            // Try Supabase first
            try {
                const ok = await ensureSupabaseReady(2000);
                if (ok) {
                    const {
                        data,
                        error
                    } = await window.supabase.from('alumni_profiles').select('*').order('created_at', {
                        ascending: false
                    });
                    if (!error && Array.isArray(data)) {
                        // Map to expected client fields
                        return data.map(r => ({
                            fullName: r.full_name,
                            studentNumber: r.student_number,
                            // store the raw value but we'll render as label later
                            degree: r.degree,
                            graduationYear: r.graduated_year || r.graduatedYear || ''
                        }));
                    }
                }
            } catch (e) {
                console.warn('Supabase alumni fetch failed', e);
            }

            // Fallback to local JSON file
            try {
                const res = await fetch('data/alumni.json', {
                    cache: 'no-store'
                });
                if (!res.ok) throw new Error('no file');
                const arr = await res.json();
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                return [];
            }
        }

        function renderTable(alumni) {
            const tbody = document.querySelector('#alumTable tbody');
            tbody.innerHTML = '';
            if (!alumni.length) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="5" class="empty">No alumni records</td>';
                tbody.appendChild(tr);
                return;
            }
            alumni.forEach(a => {
                const tr = document.createElement('tr');
                const degreeLabel = labelForDegree(a.degree);
                tr.innerHTML = `<td>${a.fullName||''}</td><td>${a.studentNumber||''}</td><td>${degreeLabel||''}</td><td>${a.graduationYear||''}</td><td><a class="card-btn" href="alumdetails.html?id=${encodeURIComponent(a.studentNumber||'')}">View</a></td>`;
                tbody.appendChild(tr);
            });
        }

        (async() => {
            const data = await loadAlumni();
            renderTable(data);
        })();

        // Listen for saves from other pages/tabs and reload
        window.addEventListener('alumni:saved', async function(e) {
            console.info('alumni:saved event received, reloading list', e && e.detail);
            const data = await loadAlumni();
            renderTable(data);
        });
    </script>
</body>

</html>
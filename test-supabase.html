<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXT STEP - Supabase Connection Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #0b66b3; margin-bottom: 20px; }
        .status { padding: 15px; margin: 15px 0; border-radius: 4px; font-weight: bold; }
        .status.loading { background: #e3f2fd; color: #0b66b3; }
        .status.success { background: #e8f5e9; color: #2e7d32; }
        .status.error { background: #ffebee; color: #d32f2f; }
        .test-button { background: #0b66b3; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 10px 5px 10px 0; }
        .test-button:hover { background: #094a8a; }
        .log { background: #f9f9f9; border: 1px solid #ddd; padding: 15px; border-radius: 4px; margin: 15px 0; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        .log-entry.info { color: #0b66b3; }
        .log-entry.success { color: #2e7d32; }
        .log-entry.error { color: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç NEXT STEP - Supabase Test</h1>
        
        <div class="status loading" id="statusDiv">
            Initializing Supabase client...
        </div>

        <button class="test-button" onclick="testSupabaseConnection()">Test Connection</button>
        <button class="test-button" onclick="testDatabase()">Test Database</button>
        <button class="test-button" onclick="clearLog()">Clear Log</button>

        <div class="log" id="logDiv"></div>
    </div>

    <script src="supabase-client.js"></script>
    <script>
        const statusDiv = document.getElementById('statusDiv');
        const logDiv = document.getElementById('logDiv');

        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logDiv.innerHTML = '';
        }

        function updateStatus(message, type) {
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            addLog(message, type);
        }

        // Monitor Supabase initialization
        (async function monitorSupabase() {
            let attempts = 0;
            while (attempts < 20) {
                if (window.supabaseReady && window.supabaseClient) {
                    updateStatus('‚úÖ Supabase client is ready!', 'success');
                    addLog('Supabase URL: ' + (window.supabaseClient.supabaseUrl || 'unknown'));
                    return;
                }
                
                if (window.supabaseError) {
                    updateStatus(`‚ùå Supabase initialization error: ${window.supabaseError}`, 'error');
                    return;
                }
                
                attempts++;
                await new Promise(r => setTimeout(r, 100));
            }
            
            updateStatus('‚ùå Supabase client failed to initialize', 'error');
        })();

        async function testSupabaseConnection() {
            updateStatus('Testing Supabase connection...', 'loading');
            
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not available');
                }

                // Try to get current session
                const { data: sessionData } = await window.supabaseClient.auth.getSession();
                addLog('Current session: ' + (sessionData?.session ? 'Logged in' : 'Not logged in'), 'info');

                // Try a simple query
                const { data, error } = await window.supabaseClient
                    .from('users')
                    .select('count', { count: 'exact' })
                    .limit(0);

                if (error) {
                    throw error;
                }

                updateStatus('‚úÖ Supabase connection successful!', 'success');
                addLog('Total users in database: ' + (data?.count || 0), 'success');
            } catch (err) {
                updateStatus(`‚ùå Connection failed: ${err.message}`, 'error');
                addLog(`Error details: ${err.message}`, 'error');
            }
        }

        async function testDatabase() {
            updateStatus('Testing database tables...', 'loading');
            
            try {
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not available');
                }

                // Test users table
                addLog('Checking users table...', 'info');
                const { error: usersError } = await window.supabaseClient
                    .from('users')
                    .select('id')
                    .limit(1);

                if (usersError) {
                    addLog(`‚ùå Users table error: ${usersError.message}`, 'error');
                } else {
                    addLog('‚úÖ Users table found', 'success');
                }

                // Test alumni_data table
                addLog('Checking alumni_data table...', 'info');
                const { error: alumniError } = await window.supabaseClient
                    .from('alumni_data')
                    .select('id')
                    .limit(1);

                if (alumniError) {
                    addLog(`‚ùå Alumni data table error: ${alumniError.message}`, 'error');
                } else {
                    addLog('‚úÖ Alumni data table found', 'success');
                }

                updateStatus('‚úÖ Database test complete', 'success');
            } catch (err) {
                updateStatus(`‚ùå Database test failed: ${err.message}`, 'error');
                addLog(`Error: ${err.message}`, 'error');
            }
        }

        addLog('Page loaded. Waiting for Supabase client...', 'info');
    </script>
</body>
</html>
